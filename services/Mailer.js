const sgMail = require("@sendgrid/mail");
const nodeEmailer = require('nodemailer');
const fs = require('fs');

const setApiKey = async () => { 
    const key = process.env.SENDGRID_KEY;
    sgMail.setApiKey(key);
}
setApiKey()

const getFileContent = (template_content) => {
    let contents = fs.readFileSync(`public/${template_content.template_name}.html`, 'utf-8');
    return contents;
}

const getTemplt = (template_name) => {
    const temps = [
        "<!DOCTYPE html><html lang=\"en\">  <head>    <meta charset=\"UTF-8\" />    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />    <title>Document</title>    <style>        .font-lato {            font-family: 'Lato', sans-serif;        }        .font-montserrat{            font-family: 'Montserrat', sans-serif        }        .text-col{             color : #473766        }        .justify{            text-align: justify;        }    </style>    <link    href=\"https://fonts.googleapis.com/css?family=Lato:400,700&display=swap\"    rel=\"stylesheet\"    type=\"text/css\"  />  <link    href=\"https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap\"    rel=\"stylesheet\"    type=\"text/css\"  />  </head>  <body style=\"background-color: rgb(249, 244, 251);\">    <center>        <div style=\"background-color: white; padding : 1rem; border-radius: 1rem; width: calc(560px);\">            <div style=\"background-color: rgb(247, 249, 250); padding:1rem; border-radius: 1rem; width : calc(520px);\">                <table        cellpadding=\"0\"        cellspacing=\"0\"        border=\"0\"        width=\"100%\"        style=\"          width: calc(500px);          border-radius: 1rem;          border-collapse: collapse;          margin: 0 auto;          background-color: white;          padding: 0;          overflow: hidden;        \"      >        <tbody>          <tr style=\"border-collapse: collapse; margin: 0; padding: 0\">            <td              width=\"100%\"              style=\"border-collapse: collapse; margin: 0; padding: 0\"            >              <table                width=\"100%\"                cellpadding=\"0\"                cellspacing=\"0\"                border=\"0\"                style=\"                  min-width: 100%;                  border-collapse: collapse;                  margin: 0;                  padding: 0;                \"              >                <tbody>                  <tr style=\"font-family: helvetica, sans-serif;                  font-weight: 100;                  text-decoration: none;                  color: #333333;                  font-size: 24px;                  border-collapse: collapse; margin: 0; padding: 0\">                    <td                      width=\"100%\"                      style=\"                        min-width: 100%;                        border-collapse: collapse;                        margin: 0;                        padding: 0;                      \"                    >                        <div style=\"margin: 0px 0px 30px 0px\">                            <div style=\"margin: 0px 0px 30px 0px\">                                <img src=\"https://cdn.discordapp.com/attachments/955281529481883729/1042356186672009246/logo.png\"                                 style=\"width: 100%;\" ></img>                            </div>                            <div style=\"margin : 0px 20px 0px 20px\">                                <p class=\"text-col font-lato\" style=\"font-size: 1.5rem; font-weight: bold; \"><span style=\"font-weight: lighter;\">Hi ${name},</p>                                <p class=\"text-col  font-monsterrat justify\" style=\"font-size: 1rem; line-height: 2rem; font-weight: 500;\">Thank you for signing up to OlBooks, to complete your sign up, here is your verification code. </p>                                <div class=\"font-monsterrat\" style=\"background-color:rgb(237, 237, 237); padding : 1rem; font-size: 1rem; font-weight: 400;\">                                    <p>${verification}</p>                                </div>                                <p class=\"text-col font-monsterrat justify\" style=\"font-size: 1rem; line-height: 2rem; font-weight: 500;\">Have a great day!</p>                            </div>                        </div>                    </td>                  </tr>                </tbody>              </table>            </td>          </tr>        </tbody>                </table>                <center>                    <table                      cellpadding=\"0\"                      cellspacing=\"0\"                      style=\"                        border-collapse: collapse;                        font-size: 13px;                        font-family: helvetica, sans-serif;                        line-height: 30px;                        border-spacing: 0px;                        width: 100%;                        margin-top: 2rem;                        width: calc(340px);                        padding: 0;                      \"                    >                      <tbody>                        <tr                          style=\"                            border-collapse: collapse;                            margin: 0;                          \"                        >                          <td                            align=\"center\"                            style=\"                              border-collapse: collapse;                              margin: 0;                              padding: 0;                            padding: 5;                            border-radius: 2%;                            \"                          >                                                          <p                                style=\"                                  font-family: helvetica, sans-serif;                                  text-decoration: none;                                  color: #383838;                                  font-size: 13px;                                  opacity: 0.7;                                  line-height: 1.5rem;                                  margin: 0;                                  padding: 0;                                \"                              >                              </p>                                                            </p>                          </td>                        </tr>                        <tr                          style=\"                            border-collapse: collapse;                            margin: 0;                            padding: 0;                          \"                        >                          <td                            align=\"center\"                            width=\"50\"                            height=\"50\"                            style=\"                              border-collapse: collapse;                              margin: 0;                              padding: 0;                            \"                          >                            <img                              src=\"https://cdn.discordapp.com/attachments/955281529481883729/1042356186672009246/logo.png\"                              alt=\"hero-image\"                              width=\"200\"                            />                          </td>                        </tr>                        <tr                          style=\"                            border-collapse: collapse;                            margin: 0;                          \"                        >                          <td                            align=\"center\"                            style=\"                              border-collapse: collapse;                              margin: 0;                              padding: 0;                            padding: 5;                            border-radius: 2%;                            \"                          >                                                          <p                              class=\"text-col font-lato\"                                style=\"                                  text-decoration: none;                                  font-size: 13px;                                  opacity : 0.7;                                  font-weight: 500;                                  color : #333333;                                  margin: 0;                                  padding: 0;                                \"                              >                              OlBooks • Metro Manila, Philippines</p>                                                            </p>                          </td>                        </tr>                                                                      </tbody>                    </table>                </center>            </div>        </div>    </center>  </body></html>",
        "<!DOCTYPE html> <html lang=\"en\">   <head>     <meta charset=\"UTF-8\" />     <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />     <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />     <title>Document</title>     <style>         .font-lato {             font-family: 'Lato', sans-serif;         }         .font-montserrat{             font-family: 'Montserrat', sans-serif         }         .text-col{              color : #594545         }         .justify{             text-align: justify;         }         .font-gentium{             font-family: 'Gentium Book Basic', serif;         }     </style>     <link     href=\"https://fonts.googleapis.com/css?family=Lato:400,700&display=swap\"     rel=\"stylesheet\"     type=\"text/css\"   />   <link     href=\"https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap\"     rel=\"stylesheet\"     type=\"text/css\"   />     <link href=\"https://fonts.googleapis.com/css2?family=Gentium+Book+Basic:ital,wght@0,400;0,700;1,400;1,700&display=swap\"      type=\"text/css\" rel=\"stylesheet\">   </head>   <body style=\"background-color: rgb(249, 244, 251);\">     <center>         <div style=\"background-color: white; padding : 1rem; border-radius: 1rem; width: calc(560px);\">             <div style=\"background-color: rgb(247, 249, 250); padding:1rem; border-radius: 1rem; width : calc(520px);\">                  <table         cellpadding=\"0\"         cellspacing=\"0\"         border=\"0\"         width=\"100%\"         style=\"           width: calc(500px);           border-radius: 1rem;           border-collapse: collapse;           margin: 0 auto;           background-color: white;           padding: 0;           overflow: hidden;         \"       >         <tbody>           <tr style=\"border-collapse: collapse; margin: 0; padding: 0\">             <td               width=\"100%\"               style=\"border-collapse: collapse; margin: 0; padding: 0\"             >               <table                 width=\"100%\"                 cellpadding=\"0\"                 cellspacing=\"0\"                 border=\"0\"                 style=\"                   min-width: 100%;                   border-collapse: collapse;                   margin: 0;                   padding: 0;                 \"               >                 <tbody>                    <tr style=\"font-family: helvetica, sans-serif;                   font-weight: 100;                   text-decoration: none;                   color: #333333;                   font-size: 24px;                   border-collapse: collapse; margin: 0; padding: 0\">                     <td                       width=\"100%\"                       style=\"                         min-width: 100%;                         border-collapse: collapse;                         margin: 0;                         padding: 0;                       \"                     >                         <div style=\"margin: 0px 0px 30px 0px\">                             <div style=\"margin: 0px 0px 30px 0px\">                                 <img src=\"https://cdn.discordapp.com/attachments/955281529481883729/1042786330461081662/forgot.png\"                                  style=\"width: 100%;\" ></img>                             </div>                             <div style=\"margin : 0px 20px 0px 20px\">                                 <p class=\"text-col font-gentium\" style=\"font-size: 1.5rem; font-weight: bold; \"><span style=\"font-weight: lighter;\">Hi, ${name}</p>                                 <p class=\"text-col  font-gentium justify\" style=\"font-size: 1.2rem; line-height: 2rem; font-weight: 500;\">${content}</p>                                 <div class=\"font-gentium\" style=\"background-color:rgb(237, 237, 237); padding : 1rem; font-size: 2rem; font-weight: 500;\">                                     <p>${verification}</p>                                 </div>                                 <p class=\"text-col  font-gentium justify\" style=\"font-size: 1.2rem; line-height: 2rem; font-weight: 500;\"> Have a great day!</p>                             </div>                         </div>                     </td>                   </tr>                 </tbody>               </table>             </td>           </tr>         </tbody>                 </table>                  <center>                     <table                       cellpadding=\"0\"                       cellspacing=\"0\"                       style=\"                         border-collapse: collapse;                         font-size: 13px;                         font-family: helvetica, sans-serif;                         line-height: 30px;                         border-spacing: 0px;                         width: 100%;                         margin-top: 2rem;                         width: calc(340px);                         padding: 0;                       \"                     >                       <tbody>                         <tr                           style=\"                             border-collapse: collapse;                             margin: 0;                           \"                         >                           <td                             align=\"center\"                             style=\"                               border-collapse: collapse;                               margin: 0;                               padding: 0;                              padding: 5;                             border-radius: 2%;                             \"                           >                                                            <p                                 style=\"                                   font-family: helvetica, sans-serif;                                   text-decoration: none;                                   color: #383838;                                   font-size: 13px;                                   opacity: 0.7;                                   line-height: 1.5rem;                                   margin: 0;                                   padding: 0;                                 \"                               >                               </p>                                                              </p>                           </td>                         </tr>                         <tr                           style=\"                             border-collapse: collapse;                             margin: 0;                             padding: 0;                           \"                         >                           <td                             align=\"center\"                             width=\"50\"                             height=\"50\"                             style=\"                               border-collapse: collapse;                               margin: 0;                               padding: 0;                             \"                           >                             <img                               src=\"https://cdn.discordapp.com/attachments/955281529481883729/1042356186672009246/logo.png\"                               alt=\"hero-image\"                               width=\"200\"                             />                           </td>                         </tr>                         <tr                           style=\"                             border-collapse: collapse;                             margin: 0;                           \"                         >                           <td                             align=\"center\"                             style=\"                               border-collapse: collapse;                               margin: 0;                               padding: 0;                              padding: 5;                             border-radius: 2%;                             \"                           >                                                            <p                               class=\"text-col font-gentium\"                                 style=\"                                   text-decoration: none;                                   font-size: 13px;                                   opacity : 0.7;                                   font-weight: 500;                                   color : #333333;                                   margin: 0;                                   padding: 0;                                 \"                               >                               OlBooks • Metro Manila, Philippines</p>                                                              </p>                           </td>                         </tr>                                                                         </tbody>                     </table>                 </center>              </div>          </div>     </center>   </body> </html>"
    ]

    const names = ["new", "forgot"]
    const idx = names.indexOf(template_name)
    if(idx === -1) return "No template :("
    return temps[idx];
}

const transTemplate = (template_content) => {
    var template = require('es6-template-strings');
    // return template(getFileContent(template_content), {...template_content})
    return template(getTemplt(template_content.template_name), {...template_content})
}

const sendMail = async(msg) => {
    try{
        const sent = await sgMail.send(msg);
        console.log("SENDING ", sent);
        // let smtpTransport = nodeEmailer.createTransport({
        //     service: 'Gmail',
        //     port: 465,
        //     auth: {
        //         user: process.env.MAIL,
        //         pass: process.env.PASS
        //     }
        // });
        
        // smtpTransport.sendMail(msg, (error, response) => {
        //     if (error) console.log("error",error);
        //     else console.log('Sucess');
        // });
    
        // smtpTransport.close();
    }catch(e){
        console.log(e)
    }
}

const sendEmail = (userEmail, template_content) => {
    /**
     * user_email : string
     * template_content : {
     *  template_name : string
     *  ...other content
     * }
     */
    
    let mailOptions = {
        // from: "uptech.coderph@gmail.com",
        from : process.env.MAIL,
        to: userEmail,
        subject : template_content.subject,    
        html: transTemplate(template_content)
    };
    console.log("options ", mailOptions.to, mailOptions.from, mailOptions.subject);
    sendMail(mailOptions)
}

module.exports = sendEmail